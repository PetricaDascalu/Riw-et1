package parser;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.io.Writer;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import mongo.MongoUsage;
import objects.DirectIndexFormat;

public class DirectIndex {

	private static DirectIndexFormat getFileTemplate(String path, Writer writer){
		DirectIndexFormat di = new DirectIndexFormat();
		Writer inWriter = null;
		File file = new File(path);
		String filename = file.getName();

		String[] aux = filename.split("\\.");

		String absolutePath = file.getAbsolutePath();

		String filePath = absolutePath.substring(0,absolutePath.lastIndexOf(File.separator));
		filename = aux[0];
		if(aux[1].equals("html")){
			di.setFileName(absolutePath);
			try {
				inWriter = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(filePath+"/"+filename+".txt"), "utf-8"));
			} catch (UnsupportedEncodingException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (FileNotFoundException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			Parser.parseInformations(inWriter, file);

			File f = new File(filePath+"/"+filename+".txt");
			HashMap<String, Integer> w = Parser.parseText(f);
			//System.out.println(Arrays.asList(w));
			di.setWords(w);
			try {
				writer.write(file.getName() + ":indexDirectMongoDB.json\n");
				inWriter.close();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		return di;
	}
	
	private static List<DirectIndexFormat> getListOfFileTemplates(List<String> paths, Writer writer){
		List<DirectIndexFormat> listOfFileTemplates = new ArrayList<DirectIndexFormat>();
		for (String path : paths) {
			DirectIndexFormat di = DirectIndex.getFileTemplate(path, writer);
			if(di.getFileName() != null && di.getWords() != null){
				listOfFileTemplates.add(di);
			}
		}
		return listOfFileTemplates;
	}
	
	public static void directIndex(String dirName){
		List<String> paths = Parser.getFiles(new File(dirName));
		Writer writer = null;
		try {
			writer = new BufferedWriter(new OutputStreamWriter(new FileOutputStream("mapare.txt"), "utf-8"));
		} catch (UnsupportedEncodingException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		} catch (FileNotFoundException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
		List<DirectIndexFormat> listOfFileTemplates = getListOfFileTemplates(paths, writer);
		//directIndexToFile(listOfFileTemplates);
		try {
			writer.close();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		MongoUsage.popolateCollectionDirect(listOfFileTemplates);
		MongoUsage.directIndexToFile();
	}

}
